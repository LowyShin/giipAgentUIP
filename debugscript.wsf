<job id="lwFileMgmt_v1.20">
<script language="VBScript">
'==============================================
' Create by Lowy Shin 2006.03.28
' Initializing for giip Service
' Change tpsn from giip notification service
' System Variables (Do not change this) -------
at = "ce196e95447b350c53d80b809a316e42"
lsSn = "71028"
lwPathLog = "../giipLogs"
lwLogFileName = "giipAgent_" & SetDtToStr(now(), "YYYYMMDD") & ".log"

' == User Custom Variables [start] =======
' Uncomment and set below to Custom Variables at Que Management

' for KVS
kfactor="FILE_MANAGE"

' examples : 
select case lssn
    case "71028"
        lwPathSource = "G:\マイドライブ\HGJWorks\WorkHistory\gundam"
        lwPathTarget = "G:\マイドライブ\HGJWorks\WorkHistory\ccn-work-old"
        lwInterval = 8
        Call lwMoveFiles(lwPathSource, lwPathTarget, lwInterval)
        lwPathSource = "G:\マイドライブ\HGJWorks\WorkHistory\formprize"
        lwPathTarget = "G:\マイドライブ\HGJWorks\WorkHistory\ccn-work-old"
        lwInterval = 15
        Call lwMoveFiles(lwPathSource, lwPathTarget, lwInterval)
        lwPathSource = "G:\マイドライブ\HGJWorks\WorkHistory\hange"
        lwPathTarget = "G:\マイドライブ\HGJWorks\WorkHistory\ccn-work-old"
        lwInterval = 15
        Call lwMoveFiles(lwPathSource, lwPathTarget, lwInterval)
        lwPathSource = "G:\マイドライブ\HGJWorks\WorkHistory\nanapachi"
        lwPathTarget = "G:\マイドライブ\HGJWorks\WorkHistory\ccn-work-old"
        lwInterval = 15
        Call lwMoveFiles(lwPathSource, lwPathTarget, lwInterval)
        lwPathSource = "G:\マイドライブ\HGJWorks\WorkHistory\wakufi"
        lwPathTarget = "G:\マイドライブ\HGJWorks\WorkHistory\ccn-work-old"
        lwInterval = 15
        Call lwMoveFiles(lwPathSource, lwPathTarget, lwInterval)
        lwLogFileWrite lwPathLog, lwLogFileName, "[" & SetDtToStr(now(), "YYYY/MM/DD HH24:MI:SS") & "] Move Old files... " & lwPathSource & vbCRLF
        lwLogFileWrite lwPathLog, lwLogFileName, "[" & SetDtToStr(now(), "YYYY/MM/DD HH24:MI:SS") & "] lwURL... " & lwURL & vbCRLF
        lwLogFileWrite lwPathLog, lwLogFileName, "[" & SetDtToStr(now(), "YYYY/MM/DD HH24:MI:SS") & "] lwURLRst... " & lwURLRst & vbCRLF
end select
' Call lwMoveFiles(Path, TermDay)

'
' == User Custom Variables [end] ==========

CntFile = 0
if lssn <> empty then
    lssn = clng(lssn)
end if
Sub lwMoveFiles(sPathSource, sPathDest, nDatediff)
	Dim lwFso, lwFolder, lwFile
	Set lwFso = WScript.CreateObject("Scripting.FileSystemObject")
	' for debug
	msgbox (sPathSource)
	Set lwFolder = lwFso.GetFolder(sPathSource)
	Set lwFiles = lwFolder.Files

	CntMoveFiles = 0

	For Each File In lwFiles
		ModDate = File.DateLastModified
		lwFileName = File.Name
		lwFileSize = File.Size
		if datediff("d", ModDate, Now()) > nDatediff then
			if len(MoveFiles) < 40000 then
				if CntMoveFiles > 0 then
					MoveFiles = MoveFiles & ","
				end if
				MoveFiles = MoveFiles & "{""FileName"":""" & lwFileName & """, ""FileSize"":" & lwFileSize & ", ""ModDate"":""" & ModDate & """}"
			end if

			lwFso.lwMoveFile sPathSource & "\" & File.Name, sPathSource & "\" & File.Name
			CntMoveFiles = CntMoveFiles + 1
		end if
	Next
	if CntMoveFiles = 0 then
		MoveFiles = "{""CntMoveFiles"":" & CntMoveFiles & ",""DelTerm"":" & nDatediff & ", ""Data"":""No file to delete.""}"
	else
		MoveFiles = "{""CntMoveFiles"":" & CntMoveFiles & ",""DelTerm"":" & nDatediff & ", ""Data"":[" & MoveFiles & "]}"
	end if

	' for KVS Put
	ktype = "lssn"
	kkey=lssn
    kvalue=MoveFiles
    if kvalue <> empty then
        Call gAPIKVSPut (at, ktype, kkey, kfactor, kvalue)
    end if

	' for Message Service(Old)
	'UserData = CheckFileName & " (" & lwFileSize & ")" & vbCRLF
	'Call lwMSP_NS_APISend02 (at, tpsn, CntFile, UserData)

	Set lwFile = Nothing
	Set lwFolder = Nothing
	Set lwFso = Nothing
End Sub

 Sub gAPIKVSPut(sk, ktype, kkey, kfactor, kvalue)
 	fv = "sk=" & sk & "&type=" & ktype & "&key=" & kkey & "&factor=" & kfactor & "&value=" & kvalue
 	lwURL = "http://giipasp.azurewebsites.net/api/kvs/kvsput.asp?" & fv
 	lwHTTPRst = lwGetHTTP (lwURL, "POST", "", "utf-8", "text")	
End Sub

 Function lwGetHTTP(url, meth, fv, charset, output)
 Dim xmlHttp
 Set xmlHttp = CreateObject("MSXML2.serverXMLHTTP")
 xmlHttp.Open meth, url, False
 	if charset = "utf-8" then
 		xmlHttp.setRequestHeader "Content-Type", " text/html; charset=utf-8"
 	else
 		xmlHttp.setRequestHeader "Content-Type", " text/html"
 	end if
 	'xmlHttp.setRequestHeader "Content-Length", "length"
 	if fv = empty then
 	  xmlHttp.Send
 	else
	  xmlHttp.Send fv
	end if
	txtData = xmlHttp.responseText
	htmlData = xmlHttp.responsebody
	if output = "html" then
		lwGetHTTP = htmlData
	else
		lwGetHTTP = txtData
	end if
End Function

Sub lwLogFileWrite(sPath, sFileName, sContent)
      Set lwFso = CreateObject("Scripting.FileSystemObject")
      if lwFso.FileExists(sPath & "\" & sFileName) then
            set lwLogFile = lwFso.opentextfile(sPath & "\" & sFileName, 8, true)
      else
            set lwLogFile =  lwFso.createtextfile(sPath & "\" & sFileName, true)
      end if

      lwLogFile.Write sContent
      lwLogFile.close
End Sub

Function SetDtToStr(dt, date_type)
      Dim mydate
      date_type = Ucase(date_type)
      if isdate(dt) then
            hour12 = hour(dt)
            if cint(hour12) > 12 then
                  hour12 = hour12 - 12
            end if
            mydate = replace (date_type, "YYYY", year(dt))
            mydate = replace (mydate, "YY", right(year(dt), 2))
            mydate = replace (mydate, "MM", right("0" & month(dt),2))
            mydate = replace (mydate, "DD", right("0" & day(dt),2))
            mydate = replace (mydate, "HH24", right("0" & hour(dt),2))
            mydate = replace (mydate, "HH", hour12)
            mydate = replace (mydate, "MI", right("0" & minute(dt),2))
            mydate = replace (mydate, "SS", right("0" & second(dt),2))
      else
            mydate = "1999/01/01 00:00:00"
      end if
      SetDtToStr = mydate
End Function


</script>
</job>
